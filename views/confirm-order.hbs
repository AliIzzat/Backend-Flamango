<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirm Your Order</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <!-- ===== TITLE ===== -->
  <section style="text-align:center; padding-top:1rem;">
    <h2 class="neon-text">
      <span style="color:tomato;">Confirm </span>
      <span style="color:rgb(173,126,6);">Your </span>
      <span style="color:blueviolet;">Order</span>
    </h2>

    {{!-- Optional: show saved customer info if session has it --}}
    {{#if customerInfo}}
      <section class="card" style="max-width:600px; margin: 1rem auto;">
        <h3>Saved Customer Info</h3>
        <p><strong>Name:</strong>  {{customerInfo.name}}</p>
        <p><strong>Email:</strong> {{customerInfo.email}}</p>
        <p><strong>Phone:</strong> {{customerInfo.phone}}</p>
        <a href="/register" class="btn-secondary">Edit details</a>
      </section>
    {{/if}}

    <h3 class="neon-text" style="margin-top:1rem;">
      <span style="color:tomato;">Delivery </span>
      <span style="color:blueviolet;">Address</span>
    </h3>
  </section>

  <!-- ===== ORDER FORM (GUEST-FRIENDLY) ===== -->
  <form
    id="orderForm"
    action="/order/confirm"
    method="POST"
    class="vertical-form"
    style="max-width:500px; margin:2rem auto;"
  >
    {{!-- Hidden fields to help backend know if coming from /register --}}
    <input
      type="hidden"
      name="isExistingCustomer"
      value="{{#if customerInfo}}true{{else}}false{{/if}}"
    />

    <!-- Hidden location fields (prefilled if backend passed {{latitude}} / {{longitude}}) -->
    <input type="hidden" name="latitude"  id="latitude"  value="{{latitude}}" />
    <input type="hidden" name="longitude" id="longitude" value="{{longitude}}" />

    <!-- ===== BASIC CUSTOMER INFO ===== -->
    <label for="customerName">Your Name:</label>
    <input
      type="text"
      id="customerName"
      name="customerName"
      placeholder="Customer Name"
      value="{{customerInfo.name}}"
      required
    />

    <label for="customerMobile">Mobile Number:</label>
    <input
      type="text"
      id="customerMobile"
      name="customerMobile"
      placeholder="Mobile Number"
      value="{{customerInfo.phone}}"
      required
    />

    <label for="customerEmail">Email (optional):</label>
    <input
      type="email"
      id="customerEmail"
      name="customerEmail"
      placeholder="Email"
      value="{{customerInfo.email}}"
    />

    <!-- ===== ADDRESS FIELDS ===== -->
    <label for="city">City:</label>
    <input
      type="text"
      id="city"
      name="city"
      placeholder="City"
      value="{{customerInfo.city}}"
      required
    />

    <label for="street">Street:</label>
    <input
      type="text"
      id="street"
      name="street"
      placeholder="Street number or name"
      value="{{customerInfo.street}}"
    />

    <label for="building">Building No.:</label>
    <input
      type="number"
      id="building"
      name="building"
      placeholder="Building number"
      value="{{customerInfo.building}}"
    />

    <label for="aptNo">Apt. Number:</label>
    <input
      type="number"
      id="aptNo"
      name="aptNo"
      placeholder="Apartment No."
      value="{{customerInfo.aptNo}}"
    />

    <label for="floor">Floor Number:</label>
    <input
      type="number"
      id="floor"
      name="floor"
      placeholder="Floor"
      value="{{customerInfo.floor}}"
    />

    <label for="zone">Zone:</label>
    <input
      type="number"
      id="zone"
      name="zone"
      placeholder="Zone"
      value="{{customerInfo.zone}}"
    />

    <label for="addressNote">Irregular / Extra Address Info:</label>
    <input
      type="text"
      id="addressNote"
      name="addressNote"
      placeholder="Villa name, landmark, etc."
      value="{{customerInfo.addressNote}}"
    />

    <div
      id="accuracy-info"
      style="margin-top:10px; font-size:14px; color:#333;"
    ></div>

    <button type="button" id="retry-location" style="margin-top:10px;">
      üìç Retry Location
    </button>

    <button type="submit" id="confirmBtn" style="margin-top:1rem;">
      Confirm Order
    </button>
  </form>

  <!-- ===== MAP (customer + restaurant) ===== -->
  <div
    id="map"
    style="width:100%; height:320px; border-radius:8px; margin:12px auto 20px;"
    data-cust-lat="{{latitude}}"
    data-cust-lng="{{longitude}}"
    data-restaurant-lat="{{restaurantLat}}"
    data-restaurant-lng="{{restaurantLng}}"
  ></div>

  <pre
    id="debug-output"
    style="background:#f3f3f3; padding:10px; font-size:.85em;"
  ></pre>

  <!-- ===== CLIENT JS: location + guards ===== -->
  <script>
    const latEl = document.getElementById('latitude');
    const lngEl = document.getElementById('longitude');
    const accEl = document.getElementById('accuracy-info');
    const debugEl = document.getElementById('debug-output');
    const retryBtn = document.getElementById('retry-location');
    const orderForm = document.getElementById('orderForm');

    function showCoords(prefix) {
      const lat = latEl.value || '';
      const lng = lngEl.value || '';
      accEl.textContent = (lat && lng)
        ? (prefix ? prefix + ' ' : '') + 'Location set: '
          + Number(lat).toFixed(6) + ', ' + Number(lng).toFixed(6)
        : 'Location not set yet.';
      if (debugEl) debugEl.textContent = 'lat=' + lat + ' lng=' + lng;
    }

    showCoords('');

    if (retryBtn) {
      retryBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('Geolocation not supported on this device/browser.');
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            latEl.value = pos.coords.latitude;
            lngEl.value = pos.coords.longitude;
            showCoords('‚úÖ');
          },
          (err) => {
            alert('Could not get location: ' + err.message);
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    if (orderForm) {
      orderForm.addEventListener('submit', (e) => {
        if (!latEl.value || !lngEl.value) {
          e.preventDefault();
          alert('Please tap "Retry Location" to capture your location before confirming.');
        }
      });
    }
  </script>

  <!-- 1) Your map logic (defines window.initMap) -->
  <script defer src="/js/initMap.js"></script>

  <!-- 2) Google Maps (uses initMap as callback) -->
  <script
    async
    defer
    src="https://maps.googleapis.com/maps/api/js?key={{apiKey}}&callback=initMap&libraries=places">
  </script>
</body>
</html>
  <div
    id="map"
    style="width:100%; height:320px; border-radius:8px; margin:12px auto 20px;"
    data-cust-lat="{{latitude}}"
    data-cust-lng="{{longitude}}"
    data-restaurant-lat="{{restaurantLat}}"
    data-restaurant-lng="{{restaurantLng}}"
  ></div>

  <pre id="debug-output" style="background:#f3f3f3; padding:10px; font-size:.85em;"></pre>

  <!-- Client JS to populate coordinates and guard submit -->
  <script>
    const latEl = document.getElementById('latitude');
    const lngEl = document.getElementById('longitude');
    const accEl = document.getElementById('accuracy-info');
    const debugEl = document.getElementById('debug-output');

    // If server sent coords in the URL (or route), reflect them in UI
    function showCoords(prefix) {
      const lat = latEl.value || '';
      const lng = lngEl.value || '';
      accEl.textContent = (lat && lng)
        ? `${prefix ? prefix + ' ' : ''}Location set: ${Number(lat).toFixed(6)}, ${Number(lng).toFixed(6)}`
        : 'Location not set yet.';
      if (debugEl) debugEl.textContent = `lat=${lat} lng=${lng}`;
    }

    showCoords('');

    // Retry Location: get fresh coordinates
    document.getElementById('retry-location').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation not supported on this device/browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          latEl.value = pos.coords.latitude;
          lngEl.value = pos.coords.longitude;
          showCoords('‚úÖ');
        },
        (err) => {
          alert('Could not get location: ' + err.message);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // Guard submit: don‚Äôt silently post with empty coords
    document.getElementById('orderForm').addEventListener('submit', (e) => {
      if (!latEl.value || !lngEl.value) {
        e.preventDefault();
        alert('Please tap "Retry Location" to capture your location before confirming.');
      }
    });
  </script>

  <!-- 1) Your map code (must expose window.initMap) -->
  <script defer src="/js/initMap.js"></script>

  <!-- 2) Google Maps (make sure you pass apiKey from the route!) -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{apiKey}}&callback=initMap&libraries=places">
  </script>
</body>
</html>
